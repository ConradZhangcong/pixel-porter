# 图片处理管理工具 - 技术架构图

## 1. 整体架构图

### 1.1 分层架构

```mermaid
graph TB
    subgraph "表现层 (Presentation Layer)"
        UI[用户界面 UI]
        Components[React 组件]
        Pages[页面组件]
    end
    
    subgraph "业务逻辑层 (Business Logic Layer)"
        RenameService[文件重命名服务]
        WatermarkService[水印服务]
        ExifCopyService[EXIF复制服务]
        BatchProcessor[批量处理器]
    end
    
    subgraph "数据访问层 (Data Access Layer)"
        ExifProcessor[EXIF处理器]
        ImageProcessor[图片处理器]
        FileProcessor[文件处理器]
        FileSystem[文件系统操作]
    end
    
    subgraph "系统交互层 (System Layer)"
        Electron[Electron 框架]
        NodeJS[Node.js 运行时]
        OS[操作系统接口]
    end
    
    UI --> Components
    Components --> Pages
    Pages --> RenameService
    Pages --> WatermarkService
    Pages --> ExifCopyService
    RenameService --> BatchProcessor
    WatermarkService --> BatchProcessor
    ExifCopyService --> BatchProcessor
    BatchProcessor --> ExifProcessor
    BatchProcessor --> ImageProcessor
    BatchProcessor --> FileProcessor
    ExifProcessor --> FileSystem
    ImageProcessor --> FileSystem
    FileProcessor --> FileSystem
    FileSystem --> Electron
    Electron --> NodeJS
    NodeJS --> OS
```

### 1.2 技术栈架构

```mermaid
graph LR
    subgraph "前端技术栈"
        React[React + TypeScript]
        AntD[Ant Design]
        Zustand[Zustand 状态管理]
        Vite[Vite 构建工具]
    end
    
    subgraph "桌面应用框架"
        Electron[Electron]
        MainProcess[主进程 Main Process]
        RendererProcess[渲染进程 Renderer Process]
    end
    
    subgraph "核心功能库"
        Exifr[exifr EXIF处理]
        Sharp[Sharp 图片处理]
        Canvas[Canvas 水印渲染]
        FS[fs/promises 文件系统]
    end
    
    subgraph "工具库"
        Dayjs[dayjs 日期处理]
        ElectronStore[electron-store 配置存储]
        ElectronLog[electron-log 日志]
    end
    
    React --> Electron
    AntD --> React
    Zustand --> React
    Vite --> React
    Electron --> MainProcess
    Electron --> RendererProcess
    MainProcess --> Exifr
    MainProcess --> Sharp
    MainProcess --> Canvas
    MainProcess --> FS
    MainProcess --> Dayjs
    MainProcess --> ElectronStore
    MainProcess --> ElectronLog
```

## 2. Electron 进程架构

### 2.1 主进程与渲染进程架构

```mermaid
graph TB
    subgraph "渲染进程 (Renderer Process)"
        direction TB
        ReactUI[React UI 界面]
        ReactComponents[React 组件]
        StateStore[Zustand 状态管理]
        IPCRenderer[IPC 客户端]
    end
    
    subgraph "IPC 通信层"
        IPCChannel[IPC 通道]
    end
    
    subgraph "主进程 (Main Process)"
        direction TB
        IPCHandler[IPC 处理器]
        WindowManager[窗口管理]
        DialogManager[对话框管理]
        
        subgraph "核心服务层"
            FileRenameService[文件重命名服务]
            WatermarkService[水印服务]
            ExifCopyService[EXIF复制服务]
        end
        
        subgraph "处理器层"
            ExifProcessor[EXIF处理器]
            ImageProcessor[图片处理器]
            FileProcessor[文件处理器]
        end
        
        subgraph "任务队列"
            TaskQueue[任务队列]
            WorkerThreads[Worker Threads]
        end
    end
    
    subgraph "系统层"
        FileSystem[文件系统]
        ExifrLib[exifr 库]
        SharpLib[Sharp 库]
        CanvasLib[Canvas 库]
    end
    
    ReactUI --> ReactComponents
    ReactComponents --> StateStore
    StateStore --> IPCRenderer
    IPCRenderer <--> IPCChannel
    IPCChannel <--> IPCHandler
    IPCHandler --> WindowManager
    IPCHandler --> DialogManager
    IPCHandler --> FileRenameService
    IPCHandler --> WatermarkService
    IPCHandler --> ExifCopyService
    FileRenameService --> ExifProcessor
    FileRenameService --> FileProcessor
    WatermarkService --> ImageProcessor
    WatermarkService --> ExifProcessor
    ExifCopyService --> ExifProcessor
    ExifProcessor --> TaskQueue
    ImageProcessor --> TaskQueue
    FileProcessor --> TaskQueue
    TaskQueue --> WorkerThreads
    ExifProcessor --> ExifrLib
    ImageProcessor --> SharpLib
    ImageProcessor --> CanvasLib
    FileProcessor --> FileSystem
    WorkerThreads --> FileSystem
```

### 2.2 IPC 通信架构

```mermaid
sequenceDiagram
    participant UI as 渲染进程 UI
    participant IPC_R as IPC Renderer
    participant IPC_M as IPC Main
    participant Service as 业务服务
    participant Processor as 处理器
    participant FS as 文件系统
    
    UI->>IPC_R: 用户操作请求
    IPC_R->>IPC_M: invoke('channel', data)
    IPC_M->>Service: 处理业务逻辑
    Service->>Processor: 调用处理器
    Processor->>FS: 文件操作
    FS-->>Processor: 返回结果
    Processor-->>Service: 处理结果
    Service-->>IPC_M: 返回数据
    IPC_M-->>IPC_R: 响应数据
    IPC_R-->>UI: 更新状态
    
    Note over IPC_M,Processor: 批量处理时
    IPC_M->>IPC_R: send('progress', data)
    IPC_R->>UI: 更新进度
```

## 3. 功能模块架构

### 3.1 文件重命名功能架构

```mermaid
graph TB
    subgraph "用户界面层"
        FileSelector[文件选择器]
        RuleConfig[命名规则配置]
        PreviewPanel[预览面板]
        ResultPanel[结果面板]
    end
    
    subgraph "业务逻辑层"
        FileScanner[文件扫描器]
        ExifExtractor[EXIF提取器]
        NamingEngine[命名规则引擎]
        ConflictDetector[冲突检测器]
        FileOperator[文件操作器]
    end
    
    subgraph "数据处理层"
        ExifCache[EXIF缓存]
        FileMetadata[文件元数据]
        RuleParser[规则解析器]
    end
    
    subgraph "存储层"
        ConfigStore[配置存储]
        TemplateStore[模板存储]
    end
    
    FileSelector --> FileScanner
    RuleConfig --> NamingEngine
    FileScanner --> ExifExtractor
    FileScanner --> FileMetadata
    ExifExtractor --> ExifCache
    NamingEngine --> RuleParser
    NamingEngine --> ConflictDetector
    ConflictDetector --> PreviewPanel
    FileOperator --> ResultPanel
    RuleConfig --> ConfigStore
    NamingEngine --> TemplateStore
```

### 3.2 水印功能架构

```mermaid
graph TB
    subgraph "用户界面层"
        ImageSelector[图片选择器]
        WatermarkConfig[水印配置面板]
        StyleConfig[样式配置]
        PreviewCanvas[预览画布]
    end
    
    subgraph "业务逻辑层"
        ImageLoader[图片加载器]
        ExifReader[EXIF读取器]
        ContentGenerator[水印内容生成器]
        StyleConfigurator[样式配置器]
        CanvasRenderer[Canvas渲染器]
        ImageComposer[图片合成器]
        ImageSaver[图片保存器]
    end
    
    subgraph "处理层"
        SharpProcessor[Sharp处理器]
        CanvasProcessor[Canvas处理器]
        FontManager[字体管理器]
    end
    
    ImageSelector --> ImageLoader
    WatermarkConfig --> ContentGenerator
    StyleConfig --> StyleConfigurator
    ImageLoader --> ExifReader
    ExifReader --> ContentGenerator
    ContentGenerator --> CanvasRenderer
    StyleConfigurator --> CanvasRenderer
    CanvasRenderer --> FontManager
    CanvasRenderer --> CanvasProcessor
    CanvasProcessor --> ImageComposer
    ImageComposer --> SharpProcessor
    SharpProcessor --> ImageSaver
    ImageSaver --> PreviewCanvas
```

### 3.3 EXIF复制功能架构

```mermaid
graph TB
    subgraph "用户界面层"
        SourceSelector[源图片选择器]
        TargetSelector[目标图片选择器]
        FieldSelector[字段选择器]
        ExifDisplay[EXIF信息显示]
        PreviewTable[预览对比表]
    end
    
    subgraph "业务逻辑层"
        ExifReader[EXIF读取器]
        ExifDisplay[EXIF显示器]
        FieldSelector[字段选择器]
        ExifMerger[EXIF合并器]
        ExifComparator[EXIF对比器]
        ExifWriter[EXIF写入器]
    end
    
    subgraph "处理层"
        ExifParser[EXIF解析器]
        ExifValidator[EXIF验证器]
        FormatChecker[格式检查器]
    end
    
    subgraph "存储层"
        BackupManager[备份管理器]
    end
    
    SourceSelector --> ExifReader
    TargetSelector --> ExifReader
    ExifReader --> ExifParser
    ExifParser --> ExifDisplay
    ExifDisplay --> FieldSelector
    FieldSelector --> ExifMerger
    ExifMerger --> ExifComparator
    ExifComparator --> ExifValidator
    ExifValidator --> FormatChecker
    FormatChecker --> ExifWriter
    ExifWriter --> BackupManager
    ExifComparator --> PreviewTable
```

## 4. 数据流架构

### 4.1 文件重命名数据流

```mermaid
flowchart TD
    Start([用户选择文件]) --> Select[文件选择器]
    Select --> Scan[扫描文件列表]
    Scan --> Extract[提取EXIF/文件属性]
    Extract --> Generate[生成新文件名]
    Generate --> Check[检测冲突]
    Check --> Preview[显示预览]
    Preview --> Confirm{用户确认?}
    Confirm -->|是| Backup{需要备份?}
    Confirm -->|否| End1([取消操作])
    Backup -->|是| BackupFile[备份文件]
    Backup -->|否| Rename[执行重命名]
    BackupFile --> Rename
    Rename --> Progress[更新进度]
    Progress --> Complete[完成处理]
    Complete --> Report[显示结果报告]
    Report --> End2([结束])
```

### 4.2 水印添加数据流

```mermaid
flowchart TD
    Start([用户选择图片]) --> Load[加载图片]
    Load --> ReadExif[读取EXIF信息]
    ReadExif --> Config[配置水印内容]
    Config --> Style[配置水印样式]
    Style --> Generate[生成水印文本]
    Generate --> Render[渲染水印图层]
    Render --> Compose[合成到原图]
    Compose --> Preview{预览效果?}
    Preview -->|不满意| Config
    Preview -->|满意| Save[保存图片]
    Save --> Progress[更新进度]
    Progress --> Complete[完成处理]
    Complete --> End([结束])
```

### 4.3 EXIF复制数据流

```mermaid
flowchart TD
    Start([用户选择源图片和目标图片]) --> LoadSource[加载源图片]
    LoadSource --> ReadSource[读取源图片EXIF]
    LoadTarget[加载目标图片] --> ReadTarget[读取目标图片EXIF]
    ReadSource --> Display[显示EXIF信息]
    ReadTarget --> Display
    Display --> Select[选择要复制的字段]
    Select --> Strategy{选择合并策略}
    Strategy -->|覆盖| Replace[替换模式]
    Strategy -->|保留| Keep[保留模式]
    Strategy -->|合并| Merge[合并模式]
    Replace --> MergeExif[合并EXIF数据]
    Keep --> MergeExif
    Merge --> MergeExif
    MergeExif --> Validate[验证EXIF数据]
    Validate --> Preview[预览对比]
    Preview --> Confirm{用户确认?}
    Confirm -->|是| Write[写入EXIF]
    Confirm -->|否| End1([取消])
    Write --> Backup{需要备份?}
    Backup -->|是| BackupFile[备份文件]
    Backup -->|否| Save[保存文件]
    BackupFile --> Save
    Save --> Progress[更新进度]
    Progress --> Complete[完成处理]
    Complete --> End2([结束])
```

## 5. 系统部署架构

### 5.1 应用打包架构

```mermaid
graph TB
    subgraph "源代码"
        SourceCode[源代码]
        Dependencies[依赖包]
        Assets[静态资源]
    end
    
    subgraph "构建工具"
        Vite[Vite 构建]
        TypeScript[TypeScript 编译]
        Webpack[Webpack 打包]
    end
    
    subgraph "Electron Builder"
        ElectronBuilder[electron-builder]
        CodeSign[代码签名]
        Package[应用打包]
    end
    
    subgraph "分发平台"
        Windows[Windows 安装包]
        MacOS[macOS 应用包]
        Linux[Linux 安装包]
    end
    
    SourceCode --> Vite
    Dependencies --> Vite
    Assets --> Vite
    Vite --> TypeScript
    TypeScript --> Webpack
    Webpack --> ElectronBuilder
    ElectronBuilder --> CodeSign
    CodeSign --> Package
    Package --> Windows
    Package --> MacOS
    Package --> Linux
```

### 5.2 运行时架构

```mermaid
graph TB
    subgraph "应用启动"
        MainEntry[主进程入口 main.ts]
        CreateWindow[创建窗口]
        LoadRenderer[加载渲染进程]
    end
    
    subgraph "运行时环境"
        MainProcess[主进程运行]
        RendererProcess[渲染进程运行]
        IPC[IPC 通信建立]
    end
    
    subgraph "资源管理"
        ConfigLoad[加载用户配置]
        TemplateLoad[加载模板]
        CacheInit[初始化缓存]
    end
    
    subgraph "功能模块"
        RenameModule[重命名模块]
        WatermarkModule[水印模块]
        ExifCopyModule[EXIF复制模块]
    end
    
    MainEntry --> CreateWindow
    CreateWindow --> LoadRenderer
    LoadRenderer --> MainProcess
    LoadRenderer --> RendererProcess
    MainProcess --> IPC
    RendererProcess --> IPC
    MainProcess --> ConfigLoad
    MainProcess --> TemplateLoad
    MainProcess --> CacheInit
    IPC --> RenameModule
    IPC --> WatermarkModule
    IPC --> ExifCopyModule
```

## 6. 模块依赖关系图

### 6.1 核心模块依赖

```mermaid
graph TD
    subgraph "共享模块 (shared)"
        Types[类型定义 types]
        Constants[常量 constants]
        Utils[工具函数 utils]
    end
    
    subgraph "核心服务 (core/services)"
        FileRenameService[文件重命名服务]
        WatermarkService[水印服务]
        ExifCopyService[EXIF复制服务]
    end
    
    subgraph "处理器 (core/processors)"
        ExifProcessor[EXIF处理器]
        ImageProcessor[图片处理器]
        FileProcessor[文件处理器]
    end
    
    subgraph "验证器 (core/validators)"
        FileValidator[文件验证器]
        ExifValidator[EXIF验证器]
    end
    
    subgraph "主进程 (main)"
        IPCHandler[IPC处理器]
        WindowManager[窗口管理]
    end
    
    subgraph "渲染进程 (renderer)"
        Components[React组件]
        Store[状态管理]
        Hooks[自定义Hooks]
    end
    
    FileRenameService --> Types
    FileRenameService --> ExifProcessor
    FileRenameService --> FileProcessor
    FileRenameService --> FileValidator
    WatermarkService --> Types
    WatermarkService --> ImageProcessor
    WatermarkService --> ExifProcessor
    ExifCopyService --> Types
    ExifCopyService --> ExifProcessor
    ExifCopyService --> ExifValidator
    ExifProcessor --> Utils
    ImageProcessor --> Utils
    FileProcessor --> Utils
    FileValidator --> Constants
    ExifValidator --> Constants
    IPCHandler --> FileRenameService
    IPCHandler --> WatermarkService
    IPCHandler --> ExifCopyService
    Components --> Store
    Components --> Hooks
    Store --> Types
    Hooks --> Types
```

## 7. 技术栈层次图

### 7.1 完整技术栈

```mermaid
graph TB
    subgraph "应用层"
        PixelPorter[Pixel Porter 应用]
    end
    
    subgraph "框架层"
        Electron[Electron 桌面框架]
        React[React UI框架]
        TypeScript[TypeScript 语言]
    end
    
    subgraph "UI组件层"
        AntDesign[Ant Design 组件库]
        ReactDnD[React-DnD 拖拽]
    end
    
    subgraph "状态管理层"
        Zustand[Zustand 状态管理]
    end
    
    subgraph "业务逻辑层"
        Services[业务服务 Services]
        Processors[处理器 Processors]
    end
    
    subgraph "功能库层"
        Exifr[exifr EXIF处理]
        Sharp[Sharp 图片处理]
        Canvas[Canvas 水印渲染]
        Dayjs[dayjs 日期处理]
    end
    
    subgraph "系统库层"
        NodeFS[fs/promises 文件系统]
        NodePath[path 路径处理]
        NodeWorker[Worker Threads]
    end
    
    subgraph "运行时层"
        NodeJS[Node.js 运行时]
        Chromium[Chromium 浏览器引擎]
    end
    
    subgraph "操作系统层"
        OS[Windows/macOS/Linux]
    end
    
    PixelPorter --> Electron
    PixelPorter --> React
    PixelPorter --> TypeScript
    React --> AntDesign
    React --> ReactDnD
    React --> Zustand
    Electron --> Services
    Services --> Processors
    Processors --> Exifr
    Processors --> Sharp
    Processors --> Canvas
    Processors --> Dayjs
    Processors --> NodeFS
    Processors --> NodePath
    Processors --> NodeWorker
    Electron --> NodeJS
    Electron --> Chromium
    NodeJS --> OS
    Chromium --> OS
```

## 8. 数据存储架构

### 8.1 存储结构

```mermaid
graph TB
    subgraph "用户数据目录"
        UserData[用户数据目录]
        
        subgraph "配置存储"
            ConfigFile[config.json<br/>用户配置]
        end
        
        subgraph "模板存储"
            RenameTemplates[rename/<br/>重命名模板]
            WatermarkTemplates[watermark/<br/>水印模板]
        end
        
        subgraph "缓存存储"
            ExifCache[exif-cache/<br/>EXIF缓存]
            PreviewCache[preview-cache/<br/>预览缓存]
        end
        
        subgraph "日志存储"
            Logs[logs/<br/>应用日志]
        end
    end
    
    subgraph "应用存储接口"
        ElectronStore[electron-store]
    end
    
    subgraph "文件系统"
        FileSystem[文件系统 API]
    end
    
    ElectronStore --> ConfigFile
    ElectronStore --> RenameTemplates
    ElectronStore --> WatermarkTemplates
    FileSystem --> ExifCache
    FileSystem --> PreviewCache
    FileSystem --> Logs
    UserData --> ConfigFile
    UserData --> RenameTemplates
    UserData --> WatermarkTemplates
    UserData --> ExifCache
    UserData --> PreviewCache
    UserData --> Logs
```

## 9. 性能优化架构

### 9.1 并发处理架构

```mermaid
graph TB
    subgraph "任务提交"
        UserAction[用户操作]
        TaskQueue[任务队列]
    end
    
    subgraph "并发控制"
        ConcurrencyLimit[并发限制器<br/>限制5-10个并发]
        WorkerPool[Worker线程池]
    end
    
    subgraph "任务处理"
        Worker1[Worker Thread 1]
        Worker2[Worker Thread 2]
        Worker3[Worker Thread N]
    end
    
    subgraph "进度反馈"
        ProgressTracker[进度跟踪器]
        IPCProgress[IPC进度推送]
    end
    
    UserAction --> TaskQueue
    TaskQueue --> ConcurrencyLimit
    ConcurrencyLimit --> WorkerPool
    WorkerPool --> Worker1
    WorkerPool --> Worker2
    WorkerPool --> Worker3
    Worker1 --> ProgressTracker
    Worker2 --> ProgressTracker
    Worker3 --> ProgressTracker
    ProgressTracker --> IPCProgress
```

## 10. 安全架构

### 10.1 安全防护层次

```mermaid
graph TB
    subgraph "用户输入层"
        UserInput[用户输入]
        InputValidation[输入验证]
    end
    
    subgraph "应用层"
        PathValidation[路径验证]
        FormatValidation[格式验证]
        SizeValidation[大小验证]
    end
    
    subgraph "系统层"
        PermissionCheck[权限检查]
        Sandbox[沙箱隔离]
    end
    
    subgraph "数据层"
        DataEncryption[数据加密]
        SecureStorage[安全存储]
    end
    
    UserInput --> InputValidation
    InputValidation --> PathValidation
    InputValidation --> FormatValidation
    InputValidation --> SizeValidation
    PathValidation --> PermissionCheck
    FormatValidation --> PermissionCheck
    SizeValidation --> PermissionCheck
    PermissionCheck --> Sandbox
    Sandbox --> DataEncryption
    DataEncryption --> SecureStorage
```

---

**文档版本**：v1.0  
**创建日期**：2026年1月9日  
**最后更新**：2026年1月9日

**说明**：本文档使用 Mermaid 图表语法，可以在支持 Mermaid 的 Markdown 查看器中查看（如 GitHub、GitLab、VS Code 的 Markdown Preview Enhanced 插件等）。

