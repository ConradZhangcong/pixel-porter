# 媒体文件处理管理工具 - 需求分析文档

## 1. 项目概述

### 1.1 项目名称
媒体文件处理管理工具（Pixel Porter）

### 1.2 项目背景
随着数字摄影和摄像设备的普及，用户积累了大量的图片和视频文件。这些媒体文件往往存在以下问题：
- 文件名混乱，缺乏统一规范
- 难以根据拍摄时间快速定位和管理媒体文件
- 缺少拍摄信息的可视化展示
- 需要批量处理大量媒体文件

### 1.3 项目目标
开发一个基于 Node.js 的命令行工具，帮助用户批量整理图片和视频文件，并通过水印技术为图片添加拍摄信息，提升媒体文件管理的效率和便利性。工具以脚本方式运行，支持命令行参数配置，无需图形界面。

## 2. 用户角色与场景

### 2.1 目标用户
- 摄影爱好者
- 需要管理大量照片和视频的普通用户
- 需要对媒体文件进行批量处理的专业用户
- 喜欢使用命令行工具的技术用户

### 2.2 典型使用场景
**场景一：批量整理媒体文件**
- 用户从相机或手机导出大量照片和视频，文件名都是自动生成的（如 IMG_001.jpg, MOV_1234.mp4）
- 用户希望根据拍摄时间重新命名这些文件，便于按时间顺序查找和管理
- 通过命令行脚本批量处理，无需打开图形界面

**场景二：创建带水印的照片版本**
- 用户希望为照片添加拍摄信息水印（如拍摄时间、相机型号、光圈、快门速度等）
- 用于分享到社交媒体或打印时保留拍摄信息
- 通过命令行参数配置水印样式和位置

**场景三：多种命名规则切换**
- 用户可能在不同的场景下需要不同的命名规则
- 有时需要按拍摄时间命名，有时需要保留原文件名，有时需要结合两者
- 通过命令行参数快速切换不同的命名规则

**场景四：元数据信息复制与修正**
- 用户对某张图片或视频进行了后期处理（如PS、Lightroom、视频编辑软件等），处理后文件的元数据信息丢失
- 用户希望将原文件（文件B）的元数据信息复制到处理后的文件（文件A）上，保留拍摄参数信息
- 或者用户有多个同一场景的媒体文件，希望统一它们的元数据信息

## 3. 功能需求

### 3.1 功能一：批量修改媒体文件名称

#### 3.1.1 功能概述
支持批量修改图片和视频文件名，可根据用户选择的规则进行重命名。通过命令行参数指定文件路径和命名规则。

#### 3.1.2 功能详述

**F1.1 文件选择**
- 支持通过命令行参数指定单个或多个媒体文件路径
- 支持指定整个文件夹进行批量处理
- 支持常见图片格式（JPG、JPEG、PNG、RAW、TIFF、HEIC等）
- 支持常见视频格式（MP4、MOV、AVI、MKV、MPEG等）
- 支持递归处理子文件夹中的媒体文件（通过 `--recursive` 参数）
- 支持通过文件扩展名过滤（如只处理 `.jpg` 和 `.mp4` 文件）

**F1.2 命名规则选择**
通过命令行参数指定命名规则，支持以下规则之一或组合：

1. **基于元数据拍摄时间**
   - 从图片EXIF信息中提取拍摄时间（DateTimeOriginal）
   - 从视频元数据中提取拍摄时间（CreationTime、DateTimeOriginal等）
   - 格式：YYYYMMDD_HHMMSS 或用户自定义格式（通过 `--date-format` 参数）
   - 示例：20240115_143022.jpg 或 20240115_143022.mp4
   - 如果文件没有拍摄时间元数据信息，应提供备选处理方案（使用文件创建时间或保留原文件名）

2. **基于文件创建时间**
   - 使用操作系统的文件创建时间（File Creation Time）
   - 格式：YYYYMMDD_HHMMSS 或用户自定义格式
   - 示例：20240115_143022.jpg

3. **基于原始文件名**
   - 保留原始文件名
   - 可选项：去除前缀、后缀或统一添加前缀/后缀（通过 `--prefix`、`--suffix` 参数）
   - 示例：原文件 IMG_001.jpg → IMG_001.jpg 或 Photo_IMG_001.jpg

4. **组合命名规则**
   - 支持组合多种规则（通过 `--pattern` 参数指定模板）
   - 示例：拍摄时间_原始文件名 → 20240115_143022_IMG_001.jpg
   - 示例：原始文件名_拍摄时间 → IMG_001_20240115_143022.jpg

**F1.3 文件名格式化选项**
- 日期时间格式自定义（通过 `--date-format` 参数，支持 YYYY/YY/MM/DD、HH/mm/ss等）
- 文件名分隔符自定义（通过 `--separator` 参数，支持下划线、横线、空格等）
- 序号填充（如果多个文件在同一秒拍摄，自动添加序号，通过 `--auto-index` 参数启用）
- 文件名长度限制设置（通过 `--max-length` 参数）

**F1.4 重命名预览**
- 通过 `--dry-run` 参数执行预览模式，显示重命名前后文件名对比，不实际执行重命名
- 对于可能产生的文件名冲突，在预览中提供警告信息
- 支持将预览结果输出到文件（通过 `--preview-output` 参数）

**F1.5 冲突处理**
- 自动检测重命名后可能产生的文件名冲突
- 通过 `--conflict-strategy` 参数指定冲突解决策略：
  - `auto-index`：自动添加序号（如：20240115_143022_001.jpg）
  - `skip`：跳过冲突文件并记录到日志
  - `error`：遇到冲突时停止处理并报错

**F1.6 备份选项**
- 通过 `--backup` 参数启用重命名前备份原文件
- 通过 `--backup-dir` 参数指定备份位置（默认为原目录下的 `.backup` 文件夹）

**F1.7 处理结果反馈**
- 在控制台显示处理进度（进度条或百分比）
- 处理完成后在控制台输出统计信息：
  - 成功重命名的文件数量
  - 失败的文件数量及原因
  - 跳过的文件数量及原因
- 支持将处理结果输出到日志文件（通过 `--log` 参数）

### 3.2 功能二：根据元数据信息创建水印版本图片

#### 3.2.1 功能概述
根据图片的EXIF信息，生成带有拍摄信息水印的新版本图片。通过命令行参数配置水印样式和输出选项。

#### 3.2.2 功能详述

**F2.1 元数据信息提取**
从图片EXIF中提取以下信息（如果存在）：
- 拍摄时间（DateTimeOriginal）
- 相机品牌（Make）
- 相机型号（Model）
- 光圈值（FNumber）
- 快门速度（ExposureTime）
- ISO感光度（ISO）
- 焦距（FocalLength）
- 曝光模式（ExposureMode）
- 白平衡（WhiteBalance）
- GPS位置信息（可选）

注意：视频文件不支持水印功能，此功能仅适用于图片文件。

**F2.2 水印内容配置**
通过命令行参数选择在水印中显示的信息项：
- 通过 `--watermark-fields` 参数指定要显示的字段（如：`date,model,aperture,shutter,iso`）
- 必选项：拍摄时间（至少显示日期）
- 可选项：相机型号、光圈、快门、ISO、焦距等
- 通过 `--watermark-text` 参数添加自定义文本内容

**F2.3 水印样式配置**
通过命令行参数配置水印样式：
- **位置选项**（`--watermark-position`）：
  - `top-left`、`top-right`、`bottom-left`、`bottom-right`
  - `custom`：通过 `--watermark-x` 和 `--watermark-y` 参数指定坐标
- **字体设置**：
  - `--watermark-font`：字体类型（默认系统字体）
  - `--watermark-size`：字体大小（默认 24）
  - `--watermark-color`：字体颜色（默认白色，支持 RGB 或颜色名称）
- **背景设置**：
  - `--watermark-background`：背景类型（`none`、`semi-transparent`、`solid`）
  - `--watermark-bg-color`：背景颜色（默认黑色）
  - `--watermark-bg-opacity`：背景透明度（0-1，默认 0.7）
- **布局设置**：
  - `--watermark-layout`：布局方式（`single-line`、`multi-line`）
  - `--watermark-align`：对齐方式（`left`、`center`、`right`）

**F2.4 水印预览**
- 通过 `--dry-run` 参数可以预览水印配置（输出配置信息，不生成实际文件）
- 对于批量处理，可以先用单个文件测试水印效果

**F2.5 输出设置**
- **输出格式**（`--output-format`）：
  - `original`：保持原格式
  - `jpg`、`png` 等：转换为指定格式
- **输出质量**：
  - `--jpg-quality`：JPG质量设置（1-100，默认 90）
  - `--png-compression`：PNG压缩级别设置（0-9，默认 6）
- **输出位置**：
  - `--output-dir`：指定输出目录（默认在原目录生成新文件）
  - `--overwrite`：覆盖原文件（需明确指定，默认不覆盖）
- **文件名规则**：
  - `--output-suffix`：自动添加后缀（如：`_watermark`，默认 `_watermark`）
  - `--output-pattern`：自定义命名规则模板

**F2.6 批量处理**
- 支持批量处理多个图片文件（通过指定文件夹或文件列表）
- 支持递归处理子文件夹（通过 `--recursive` 参数）
- 在控制台显示批量处理进度

**F2.7 处理结果反馈**
- 在控制台显示处理进度
- 处理完成后显示统计信息：
  - 成功添加水印的图片数量
  - 失败的图片数量及原因（如：无EXIF信息、文件损坏等）
  - 跳过的图片数量及原因
- 支持将处理结果输出到日志文件（通过 `--log` 参数）

**F2.8 原图保护**
- 默认不覆盖原图，生成新文件
- 如选择覆盖原图，需通过 `--overwrite` 参数明确指定

### 3.3 功能三：元数据信息复制与修改

#### 3.3.1 功能概述
支持选择两个媒体文件，读取源文件（文件B）的元数据信息（EXIF/视频元数据），并将这些信息复制或修改到目标文件（文件A）的元数据中。通过命令行参数指定源文件和目标文件。

#### 3.3.2 功能详述

**F3.1 文件选择**
- 通过命令行参数指定两个文件：
  - `--target`：目标文件（文件A），需要被修改元数据信息的文件
  - `--source`：源文件（文件B），提供元数据信息的参考文件
- 支持常见图片格式（JPG、JPEG、PNG、RAW、TIFF、HEIC等）
- 支持常见视频格式（MP4、MOV、AVI、MKV等）
- 支持批量处理：一个源文件对应多个目标文件（通过 `--target-dir` 或文件列表）

**F3.2 元数据信息读取与显示**
从源文件中读取元数据信息（如果存在）：
- **图片文件（EXIF）**：
  - 拍摄时间（DateTimeOriginal、DateTimeDigitized）
  - 相机品牌（Make）、相机型号（Model）
  - 光圈值（FNumber）、快门速度（ExposureTime）
  - ISO感光度（ISO）、焦距（FocalLength）
  - 曝光模式（ExposureMode）、白平衡（WhiteBalance）
  - 闪光灯模式（Flash）、测光模式（MeteringMode）
  - GPS位置信息（GPSLatitude、GPSLongitude、GPSAltitude等）
  - 其他EXIF标签信息
- **视频文件（元数据）**：
  - 创建时间（CreationTime、DateTimeOriginal）
  - 设备信息（Make、Model）
  - 编码信息（Codec、Bitrate等）
  - GPS位置信息（如果存在）
  - 其他视频元数据标签

通过 `--show-metadata` 参数可以在控制台显示读取到的元数据信息。

**F3.3 元数据信息选择**
通过命令行参数选择要复制的元数据信息项：
- **全部复制**（`--copy-all`）：复制源文件的所有元数据信息到目标文件
- **部分复制**（`--copy-fields`）：用户可选择需要复制的字段
  - 基本拍摄信息（拍摄时间、设备品牌、型号等）
  - 拍摄参数（光圈、快门、ISO、焦距等，仅图片）
  - 位置信息（GPS坐标等）
  - 其他自定义字段
- **选择性覆盖**（`--overwrite-strategy`）：对于目标文件已存在的元数据信息，可选择：
  - `replace`：用源文件的信息替换目标文件的信息
  - `keep`：保留目标文件的原有信息
  - `merge`：如果目标文件缺少某些字段，则从源文件复制

**F3.4 元数据信息预览**
- 通过 `--dry-run` 参数执行预览模式，在执行修改前显示：
  - 目标文件的当前元数据信息
  - 源文件的元数据信息
  - 修改后将应用到目标文件的元数据信息（对比显示）
- 预览模式下不实际执行修改操作

**F3.5 批量处理支持**
- 支持选择一个源文件（文件B）和多个目标文件（文件A1、A2、A3...）
- 通过 `--target-dir` 参数指定目标文件夹，批量处理文件夹中的所有文件
- 通过 `--target-list` 参数指定目标文件列表（文件路径列表）
- 将源文件的元数据信息批量复制到多个目标文件中
- 支持递归处理子文件夹（通过 `--recursive` 参数）
- 在控制台显示批量处理进度

**F3.6 处理选项**
- **输出方式**：
  - `--overwrite`：覆盖原文件，直接修改目标文件的元数据信息（需明确指定）
  - 默认：生成新文件，保持原文件不变，生成带有新元数据信息的新文件
    - `--output-suffix`：新文件名后缀（默认 `_metadata`）
    - `--output-pattern`：自定义命名规则模板
- **备份选项**：
  - `--backup`：在执行覆盖操作前，备份原文件
  - `--backup-dir`：指定备份位置（默认为原目录下的 `.backup` 文件夹）

**F3.7 兼容性处理**
- 如果目标文件的格式不支持元数据写入（如某些PNG格式），在控制台提供提示和转换建议
- 如果源文件缺少某些元数据信息，在预览中明确标识
- 对于不兼容的元数据字段，提供警告信息
- 对于视频文件，不同格式的元数据支持程度不同，需要明确提示

**F3.8 处理结果反馈**
- 在控制台显示处理进度
- 处理完成后显示统计信息：
  - 成功修改元数据信息的文件数量
  - 失败的文件数量及原因（如：格式不支持、文件损坏、权限问题等）
  - 部分成功的文件数量及详细说明（如：某些字段无法写入）
- 支持将处理结果输出到日志文件（通过 `--log` 参数）

**F3.9 原文件保护**
- 默认不覆盖原文件，生成新文件
- 如选择覆盖原文件，需通过 `--overwrite` 参数明确指定
- 建议使用 `--backup` 参数在执行覆盖操作前备份原文件

## 4. 非功能需求

### 4.1 性能需求
- 批量处理大量媒体文件时，应保持良好的响应速度
- 单个文件处理时间应在合理范围内（图片建议3秒以内，视频根据文件大小）
- 支持大文件处理（RAW格式、高分辨率图片、4K视频等）
- 支持并行处理多个文件（通过 `--parallel` 参数指定并发数）

### 4.2 兼容性需求
- 支持主流的图片格式（JPG、JPEG、PNG、RAW、TIFF、HEIC、WebP等）
- 支持主流的视频格式（MP4、MOV、AVI、MKV、MPEG、WMV等）
- 支持不同相机品牌生成的EXIF信息
- 支持不同设备生成的视频元数据
- 兼容主流操作系统（Windows、macOS、Linux）
- 需要 Node.js 运行环境（建议 Node.js 18+）

### 4.3 易用性需求
- 命令行参数清晰直观，提供详细的帮助信息（`--help`）
- 提供操作提示和错误信息
- 错误信息清晰明确，便于用户理解和处理
- 支持配置文件（JSON/YAML）保存常用参数组合
- 提供使用示例和文档

### 4.4 可靠性需求
- 处理失败时不影响原文件（默认生成新文件，不覆盖原文件）
- 提供备份功能，在执行覆盖操作前备份原文件
- 异常情况下保证数据安全
- 提供详细的错误日志，便于问题排查

### 4.5 可扩展性需求
- 采用模块化设计，便于未来添加新功能
- 支持自定义命名规则模板的保存和复用（通过配置文件）
- 支持自定义水印模板的保存和复用（通过配置文件）
- 支持插件机制，便于扩展新的文件格式支持

## 5. 约束条件

### 5.1 技术约束
- 需要能够读取和处理图片EXIF信息和视频元数据
- 需要支持图片编辑和生成（用于水印功能）
- 需要处理可能缺失或不完整的元数据信息
- 需要 Node.js 运行环境
- 某些视频格式的元数据读写支持可能有限

### 5.2 业务约束
- 修改元数据信息需要用户通过 `--overwrite` 参数明确确认
- 水印处理不应过度影响原图视觉效果
- 处理大量文件时需要考虑磁盘空间
- 元数据信息修改应遵循相关标准规范（EXIF、XMP等），确保兼容性
- 视频文件的元数据修改可能受格式限制，需要明确提示用户

## 6. 功能优先级

### 6.1 高优先级（MVP功能）
1. 基于元数据拍摄时间的文件重命名（支持图片和视频）
2. 基于文件创建时间的文件重命名
3. 简单的EXIF水印添加（固定位置、固定样式，仅图片）
4. 批量处理支持（图片和视频）
5. 基本的元数据信息复制功能（两个文件之间的元数据复制）
6. 命令行参数解析和帮助信息

### 6.2 中优先级
1. 组合命名规则
2. 水印样式自定义（通过命令行参数）
3. 文件名冲突处理
4. 处理预览功能（`--dry-run`）
5. 元数据信息选择性复制（部分字段选择）
6. 元数据信息批量复制（一对多）
7. 视频文件元数据支持

### 6.3 低优先级（增强功能）
1. 文件夹递归处理
2. 水印模板保存和复用（通过配置文件）
3. 命名规则模板保存和复用（通过配置文件）
4. GPS信息显示和处理
5. 并行处理支持
6. 配置文件支持（JSON/YAML）

## 7. 风险与假设

### 7.1 风险
1. **元数据信息缺失或不完整**：部分图片和视频可能没有元数据信息，需要提供合理的备选方案
2. **文件名冲突**：批量重命名可能产生文件名冲突
3. **性能问题**：处理大量或超大文件（特别是视频）时可能影响性能
4. **格式兼容性**：不同格式的图片EXIF信息结构可能不同，某些格式可能不支持EXIF写入；视频格式的元数据支持程度差异较大
5. **元数据写入失败**：某些文件格式或受保护的文件可能无法写入元数据信息
6. **元数据标准兼容性**：不同设备生成的元数据信息可能存在兼容性问题
7. **视频元数据支持有限**：某些视频格式的元数据读写可能受限于底层库的支持

### 7.2 假设
1. 用户提供的媒体文件可正常读取
2. 用户有足够的磁盘空间存储处理后的文件
3. 用户对命令行工具有一定了解，能够使用命令行参数
4. 用户对元数据信息有一定了解，能够理解相关选项的含义
5. 用户已安装 Node.js 运行环境

## 8. 验收标准

### 8.1 文件重命名功能验收标准
- 能够正确提取图片EXIF和视频元数据中的拍摄时间信息
- 能够按照用户通过命令行参数指定的规则成功重命名文件
- 能够正确处理文件名冲突（根据冲突策略）
- 处理结果准确率达到100%
- 支持图片和视频文件的批量重命名

### 8.2 水印功能验收标准
- 能够正确提取并显示图片EXIF信息
- 水印位置、样式符合用户通过命令行参数配置的要求
- 生成的水印图片质量达到可接受水平
- 原图文件完整性得到保护（默认不覆盖原文件）
- 支持批量处理多个图片文件

### 8.3 元数据信息复制功能验收标准
- 能够正确读取源文件（文件B）的元数据信息（EXIF或视频元数据）
- 能够正确将选择的元数据信息写入目标文件（文件A）
- 支持用户通过命令行参数选择要复制的元数据字段
- 修改后的元数据信息可以被其他软件正确读取和识别
- 原文件完整性得到保护（默认生成新文件，不覆盖原文件）
- 批量处理时，所有目标文件的元数据信息修改准确率达到100%
- 支持图片和视频文件的元数据复制（在格式支持的前提下）

## 9. 命令行使用示例

### 9.1 文件重命名示例
```bash
# 基于EXIF时间重命名单个文件
pixel-porter rename --input photo.jpg --rule exif-time

# 批量重命名文件夹中的所有图片和视频
pixel-porter rename --input-dir ./photos --rule exif-time --recursive

# 使用自定义日期格式
pixel-porter rename --input-dir ./photos --rule exif-time --date-format "YYYY-MM-DD_HHmmss"

# 预览重命名结果（不实际执行）
pixel-porter rename --input-dir ./photos --rule exif-time --dry-run
```

### 9.2 水印功能示例
```bash
# 为单个图片添加水印
pixel-porter watermark --input photo.jpg --watermark-fields "date,model,aperture,iso"

# 批量添加水印，输出到指定目录
pixel-porter watermark --input-dir ./photos --output-dir ./watermarked --watermark-position bottom-right

# 自定义水印样式
pixel-porter watermark --input photo.jpg --watermark-size 32 --watermark-color "255,255,255" --watermark-bg-opacity 0.8
```

### 9.3 元数据复制示例
```bash
# 复制单个文件的元数据
pixel-porter copy-metadata --source original.jpg --target processed.jpg

# 批量复制元数据（一个源文件对应多个目标文件）
pixel-porter copy-metadata --source original.jpg --target-dir ./processed --copy-all

# 选择性复制部分字段
pixel-porter copy-metadata --source original.jpg --target processed.jpg --copy-fields "date,model,aperture"

# 预览元数据复制结果
pixel-porter copy-metadata --source original.jpg --target processed.jpg --dry-run --show-metadata
```

---

**文档版本**：v2.0  
**创建日期**：2026年1月9日
**最后更新**：2026年1月28日
**主要变更**：
- 从图形界面改为命令行脚本方式
- 扩展支持视频等媒体文件处理
- 更新所有功能描述以反映命令行使用方式